<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries for PDF, Excel, and ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, deleteDoc, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDbt7DDol8jNbi3HERDBQ0QoKePszS_ziY",
            authDomain: "guard-d75d6.firebaseapp.com",
            projectId: "guard-d75d6",
            storageBucket: "guard-d75d6.firebasestorage.app",
            messagingSenderId: "610027210849",
            appId: "1:610027210849:web:cae057a05b36ebccc10220"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'dashboard-web-v1';

        function ReportApp() {
            const [user, setUser] = React.useState(null);
            const [type, setType] = React.useState('patrol_logs');
            const [data, setData] = React.useState([]);
            const [month, setMonth] = React.useState(new Date().toISOString().slice(0, 7));
            
            const [showModal, setShowModal] = React.useState(false);
            const [isEditing, setIsEditing] = React.useState(false);
            const [selectedId, setSelectedId] = React.useState(null);
            const [formData, setFormData] = React.useState({ f1: '', f2: '', f3: '' });

            React.useEffect(() => {
                const initAuth = async () => {
                    await signInAnonymously(auth);
                };
                initAuth();
                const unsubAuth = onAuthStateChanged(auth, setUser);
                return () => unsubAuth();
            }, []);

            React.useEffect(() => {
                if (!user) return;
                
                // Tentukan field pengurutan berdasarkan tipe koleksi
                let orderField = 'timestamp';
                if (type === 'incidents') orderField = 'date';
                if (type === 'visitors') orderField = 'timeIn';

                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', type), 
                    orderBy(orderField, 'desc')
                );

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setData(snapshot.docs.map(d => ({id: d.id, ...d.data()})));
                }, (error) => {
                    console.warn("Query Error (Kemungkinan field order tidak ada):", error);
                    // Fallback jika field orderField tidak ditemukan di dokumen lama
                    const fallbackQ = query(collection(db, 'artifacts', appId, 'public', 'data', type));
                    onSnapshot(fallbackQ, s => setData(s.docs.map(d => ({id: d.id, ...d.data()}))));
                });
                return () => unsubscribe();
            }, [type, user]);

            const filtered = data.filter(d => {
                const rawDate = d.timestamp || d.date || d.timeIn;
                if (!rawDate) return false;
                
                const dateVal = rawDate.toDate ? rawDate.toDate() : new Date(rawDate);
                return !isNaN(new Date(dateVal).getTime()) && new Date(dateVal).toISOString().slice(0,7) === month;
            });

            const getLabels = () => {
                if(type === 'patrol_logs') return { c2: 'Petugas', c3: 'Cekpoin', c4: 'Catatan', title: 'Patroli Cekpoin' };
                if(type === 'visitors') return { c2: 'Nama Tamu', c3: 'Asal Perusahaan', c4: 'Keperluan', title: 'Buku Tamu' };
                return { c2: 'Pelapor', c3: 'Lokasi Kejadian', c4: 'Keterangan', title: 'Insiden' };
            };
            const labels = getLabels();

            // --- EXPORT LOGIC ---
            const downloadPDF = () => {
                if(!filtered.length) return alert("Data kosong");
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(16); doc.text(`Laporan ${labels.title}`, 14, 20);
                doc.setFontSize(10); doc.text(`Periode: ${month}`, 14, 28);

                const tableRows = filtered.map(item => [
                    new Date(item.timestamp?.toDate ? item.timestamp.toDate() : (item.timestamp||item.date||item.timeIn)).toLocaleString('id-ID'),
                    item.officer || item.name,
                    item.location || item.company,
                    item.notes || item.status,
                    ""
                ]);

                doc.autoTable({
                    head: [["Waktu", labels.c2, labels.c3, labels.c4, "Foto"]],
                    body: tableRows, startY: 35, theme: 'grid',
                    headStyles: { fillColor: [41, 128, 185] },
                    styles: { valign: 'middle', minCellHeight: 12, fontSize: 8 },
                    didDrawCell: (d) => {
                        if (d.column.index === 4 && d.section === 'body') {
                            const item = filtered[d.row.index];
                            if (item?.photos?.length) { 
                                try { doc.addImage(item.photos[0], 'JPEG', d.cell.x+2, d.cell.y+2, 8, 8); } catch(e){} 
                            }
                        }
                    }
                });
                doc.save(`Laporan_${type}_${month}.pdf`);
            };

            const downloadExcel = () => {
                if(!filtered.length) return alert("Data kosong");
                let html = `<html><head><meta charset="UTF-8"><style>table{border-collapse:collapse;} th{background:#2980b9;color:white;padding:8px;border:1px solid #ccc;} td{padding:8px;border:1px solid #ccc;vertical-align:middle;}</style></head><body>`;
                html += `<h2>Laporan ${labels.title} - ${month}</h2><table><thead><tr><th>Waktu</th><th>${labels.c2}</th><th>${labels.c3}</th><th>${labels.c4}</th><th>Foto</th></tr></thead><tbody>`;
                filtered.forEach(d => {
                    const img = (d.photos?.length) ? `<img src="${d.photos[0]}" width="50" height="50">` : '-';
                    html += `<tr><td>${new Date(d.timestamp?.toDate ? d.timestamp.toDate() : (d.timestamp||d.date||d.timeIn)).toLocaleString('id-ID')}</td><td>${d.officer||d.name}</td><td>${d.location||d.company}</td><td>${d.notes||d.status}</td><td style="text-align:center">${img}</td></tr>`;
                });
                html += `</tbody></table></body></html>`;
                saveAs(new Blob([html], {type: 'application/vnd.ms-excel'}), `Laporan_${type}_${month}.xls`);
            };

            const downloadZip = async () => {
                if(!filtered.length) return alert("Data kosong");
                const zip = new JSZip();
                let count = 0;
                filtered.forEach(d => {
                    if(d.photos?.length) d.photos.forEach((p, i) => {
                        try {
                            const base64Data = p.split(',')[1];
                            if(base64Data) {
                                const name = (d.location || d.company || 'foto').replace(/[^a-z0-9]/gi, '_');
                                const time = new Date(d.timestamp?.toDate ? d.timestamp.toDate() : (d.timestamp||d.date||d.timeIn)).getTime();
                                zip.file(`${name}_${time}_${i}.jpg`, base64Data, {base64:true}); count++;
                            }
                        } catch(e){}
                    });
                });
                if(!count) return alert("Tidak ada foto ditemukan.");
                saveAs(await zip.generateAsync({type:"blob"}), `Koleksi_Foto_${month}.zip`);
            };

            const openEdit = (item) => {
                setIsEditing(true); setSelectedId(item.id);
                setFormData({ f1: item.officer || item.name || '', f2: item.location || item.company || '', f3: item.notes || item.status || '' });
                setShowModal(true);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const payload = type === 'visitors' ? 
                    { name: formData.f1, company: formData.f2, status: formData.f3 } : 
                    { officer: formData.f1, location: formData.f2, notes: formData.f3 };

                try {
                    if (isEditing) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', type, selectedId), payload);
                    }
                    setShowModal(false);
                } catch (err) { alert(err.message); }
            };

            const deleteItem = async (id) => { if(confirm("Hapus data?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', type, id)); };

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-6 font-sans text-slate-900">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h1 className="text-2xl font-bold text-slate-800 flex items-center">
                            <i className="fas fa-shield-alt text-blue-600 mr-3"></i> Pusat Laporan Keamanan
                        </h1>
                        <a href="https://proops-support.github.io/App/" className="bg-slate-800 hover:bg-slate-900 text-white px-6 py-2.5 rounded-lg shadow-md flex gap-2 items-center font-bold transition duration-200">
                            <i className="fas fa-home"></i> Home
                        </a>
                    </div>

                    <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 mb-6 flex flex-col md:flex-row gap-4 items-end justify-between">
                        <div className="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                            <div className="flex flex-col gap-1">
                                <label className="text-xs font-bold text-slate-500 uppercase">Kategori</label>
                                <select value={type} onChange={e=>setType(e.target.value)} className="border border-slate-300 p-2.5 rounded-lg outline-none min-w-[220px]">
                                    <option value="patrol_logs">Laporan Patroli (Cekpoin)</option>
                                    <option value="incidents">Laporan Insiden</option>
                                    <option value="visitors">Buku Tamu</option>
                                </select>
                            </div>
                            <div className="flex flex-col gap-1">
                                <label className="text-xs font-bold text-slate-500 uppercase">Bulan</label>
                                <input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="border border-slate-300 p-2 rounded-lg outline-none"/>
                            </div>
                        </div>
                        <div className="flex gap-2 w-full md:w-auto">
                            <button onClick={downloadPDF} className="flex-1 md:flex-none bg-red-600 hover:bg-red-700 text-white px-4 py-2.5 rounded-lg text-sm font-bold flex gap-2 items-center justify-center transition">
                                <i className="fas fa-file-pdf"></i> PDF
                            </button>
                            <button onClick={downloadExcel} className="flex-1 md:flex-none bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 rounded-lg text-sm font-bold flex gap-2 items-center justify-center transition">
                                <i className="fas fa-file-excel"></i> EXCEL
                            </button>
                            <button onClick={downloadZip} className="flex-1 md:flex-none bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2.5 rounded-lg text-sm font-bold flex gap-2 items-center justify-center transition">
                                <i className="fas fa-images"></i> FOTO ZIP
                            </button>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-[#2980b9] text-white uppercase text-xs font-bold">
                                <tr>
                                    <th className="p-4 border-r border-blue-400/30">Waktu</th>
                                    <th className="p-4 border-r border-blue-400/30">{labels.c2}</th>
                                    <th className="p-4 border-r border-blue-400/30">{labels.c3}</th>
                                    <th className="p-4 border-r border-blue-400/30">Catatan</th>
                                    <th className="p-4 border-r border-blue-400/30 text-center">Foto</th>
                                    <th className="p-4 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filtered.map((item, i) => (
                                    <tr key={item.id} className={i % 2 === 0 ? 'bg-white' : 'bg-slate-50 hover:bg-blue-50 transition'}>
                                        <td className="p-4 text-slate-600 whitespace-nowrap">
                                            {new Date(item.timestamp?.toDate ? item.timestamp.toDate() : (item.timestamp||item.date||item.timeIn)).toLocaleString('id-ID')}
                                        </td>
                                        <td className="p-4 font-bold">{item.officer || item.name}</td>
                                        <td className="p-4"><span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold uppercase">{item.location || item.company}</span></td>
                                        <td className="p-4 text-slate-500 italic">{item.notes || item.status || '-'}</td>
                                        <td className="p-4 text-center">
                                            {item.photos?.length ? <img src={item.photos[0]} className="w-10 h-10 rounded-full mx-auto object-cover border-2 border-white shadow-sm"/> : '-'}
                                        </td>
                                        <td className="p-4 text-center">
                                            <div className="flex justify-center gap-2">
                                                <button onClick={()=>openEdit(item)} className="text-yellow-600 p-2 hover:bg-yellow-50 rounded transition"><i className="fas fa-pencil-alt"></i></button>
                                                <button onClick={()=>deleteItem(item.id)} className="text-red-600 p-2 hover:bg-red-50 rounded transition"><i className="fas fa-trash-alt"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                                {filtered.length === 0 && (
                                    <tr><td colSpan="6" className="p-16 text-center text-slate-400 italic">Data tidak ditemukan untuk periode ini.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>

                    {showModal && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-[fadeIn_0.2s]">
                                <div className="bg-blue-600 p-4 text-white flex justify-between items-center">
                                    <h3 className="font-bold">Edit Data Laporan</h3>
                                    <button onClick={()=>setShowModal(false)} className="text-2xl leading-none">&times;</button>
                                </div>
                                <form onSubmit={handleSubmit} className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{labels.c2}</label>
                                        <input required type="text" value={formData.f1} onChange={e=>setFormData({...formData, f1: e.target.value})} className="w-full border p-2.5 rounded-lg outline-none focus:ring-2 focus:ring-blue-500"/>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{labels.c3}</label>
                                        <input required type="text" value={formData.f2} onChange={e=>setFormData({...formData, f2: e.target.value})} className="w-full border p-2.5 rounded-lg outline-none focus:ring-2 focus:ring-blue-500"/>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{labels.c4}</label>
                                        <textarea value={formData.f3} onChange={e=>setFormData({...formData, f3: e.target.value})} rows="3" className="w-full border p-2.5 rounded-lg outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                    </div>
                                    <div className="flex gap-3 pt-4">
                                        <button type="button" onClick={()=>setShowModal(false)} className="flex-1 py-2.5 bg-slate-100 rounded-lg font-bold hover:bg-slate-200 transition">Batal</button>
                                        <button type="submit" className="flex-1 py-2.5 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 transition">Simpan Perubahan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<ReportApp />);
    </script>
    <style>@keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }</style>
</body>
</html>
